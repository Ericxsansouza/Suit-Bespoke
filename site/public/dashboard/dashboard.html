<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUIT'Bespoke | Dashboard</title>
    <link rel="stylesheet" href="../css/index.style.css">
    <link rel="stylesheet" href="../css/global.style.css">
    <script src="../js/script.js"></script>
    <link rel="shortcut icon" type="imagem/x-icon" href="../assets/s.png">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
    href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload=" atualizarFeed()">
    <header class="main-header">
        <div class="header_nav">
            <button class="btn_toggle" onclick="abrirNav()">
                <span class="nav_icon">
                    <img class="nav_icon-hamburguer" src="../assets/icons/menu-de-tres-linhas.png" alt="">
                </span>
            </button>
        </div>
        <div class="header_nav_overlay" id="actionNav">
            <span><a class="fecharNavX" onclick="fecharNav()">&times;</a></span>
            <div class="container">
                <div class="navegation_nav">
                    <details class="collapse">
                        <summary class="title">Ternos</summary>
                        <a href="../SectionClassic.html">Clássicos</a><br>
                        <a href="../sectionComteporary.html">Contemporâneo</a><br>
                        <a href="../sectionTuxedo.html">Tuxedo</a>
                    </details>
                    <details class="collapse">
                        <summary class="title">Sapatos</summary>
                        <a href="../sectionOxford.html">Oxford</a><br>
                        <a href="../sectionMonkStrap.html">Monk Straps</a><br>
                        <a href="../sectionLoafer.html">Loafer</a>
                    </details>
                    <details class="collapse">
                        <summary class="title">Acessórios</summary>
                        <a href="../sectionTies.html">Gravatas</a><br>
                        <a href="../sectionCinto.html">Cinto</a><br>
                        <a href="../sectionPocket.html">Pocket Squares</a><br>
                    </details>
                    <img src="../assets/s.png" alt="">
                </div>
            </div>
        </div>
        <div class="header_nav_title">
            <h1 class="nav_title" onchange="inicializar()">SUIT'Bespoke</h1>
        </div>
        <div class="header_actions">
            <div class="header__actions-item">
                <button onclick="entrar()"><img src="../assets/icons/perfil-de-usuario.png" alt=""></a></button>
            </div>
            <div class="header__actions-item">
                <a href="../dashboard.html"><img src="../assets/icons/configuracao.png" alt=""></a>
            </div>
        </div>
    </header>

    <div class="graph">
        <canvas id="lineChart" width="700" height="200"></canvas>
    </div>
</body>
</html>

<script>
    // window.onload = obterDadosGrafico(1);
  window.onload = obterDadosGrafico(1);

function aguardarCarregamento() {
  setInterval(() => obterDadosGrafico(1), 2000)
}

// API | começo

let proximaAtualizacao;

// verificar_autenticacao();

function obterDadosGrafico(idUsuario) {
  // alterarTitulo(idFreezer);

  // if (proximaAtualizacao != undefined) {
  //   clearTimeout(proximaAtualizacao);
  // }

  fetch(`/medidas/buscar/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
      response.json().then(function (resposta) {
        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
        resposta.reverse();

        plotarGrafico(resposta, idUsuario);
      });
    } else {
      console.error('Nenhum dado encontrado ou erro na API');
    }
  })
    .catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}

//Esta função (plotarGrafico) usa os dados capturados na função anterior para criar o gráfico

function plotarGrafico(resposta, idUsuario) {
  console.log('iniciando plotagem do gráfico...');

  // Criando estrutura para plotar gráfico - labels
  let labels = [];

  // Criando estrutura para plotar gráfico - dados
  let dados = {
    labels: labels,
    datasets: [{
      label: 'Cadastros',
      data: [],
      fill: false,
      borderColor: 'rgb(199, 52, 52)',
      tension: 0.1
    }]
  };

  console.log('----------------------------------------------')
  console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
  console.log(resposta)

  // Inserindo valores recebidos em estrutura para plotar o gráfico
  for (i = 0; i < resposta.length; i++) {
    var registro = resposta[i];
    labels.push(registro.momento_grafico);
    dados.datasets[0].data.push(registro.temperatura);
  }

  console.log('----------------------------------------------')
  console.log('O gráfico será plotado com os respectivos valores:')
  console.log('Labels:')
  console.log(labels)
  console.log('Dados:')
  console.log(dados.datasets)
  console.log('----------------------------------------------')

  // Criando estrutura para plotar gráfico - config
  const config = {
    type: 'bar',
    data: dados,
  };

  let myChart = new Chart(
    document.getElementById('lineChart'),
    config
  );

  setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
}

// Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página

function atualizarGrafico(idUsuario, dados, myChart) {

  fetch(`/medidas/buscar/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
      response.json().then(function (novoRegistro) {

        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
        console.log(`Dados atuais do gráfico:`);
        console.log(dados);

        // document.getElementById("avisoCaptura").innerHTML = ""

        if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
          console.log("---------------------------------------------------------------")
          console.log("Como não há dados novos para captura, o gráfico não atualizará.")
          // document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
          console.log("Horário do novo dado capturado:")
          console.log(novoRegistro[0].momento_grafico)
          console.log("Horário do último dado capturado:")
          console.log(dados.labels[dados.labels.length - 1])
          console.log("---------------------------------------------------------------")
        } else {
          // tirando e colocando valores no gráfico
          dados.labels.shift(); // apagar o primeiro
          dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

          dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
          dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

          myChart.update();
        }

        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
      });
    } else {                                                
      console.error('Nenhum dado encontrado ou erro na API');
      // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
      proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
    }
  })
    .catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}
</script>